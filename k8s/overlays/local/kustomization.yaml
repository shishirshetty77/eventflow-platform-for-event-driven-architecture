apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

namePrefix: ""
nameSuffix: ""

# Local/Kind specific configurations
labels:
  - pairs:
      environment: local

# Patches for local environment
patches:
  # Use standard StorageClass for Kind
  - target:
      kind: StatefulSet
      name: zookeeper
    patch: |-
      - op: add
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: standard
  - target:
      kind: StatefulSet
      name: kafka
    patch: |-
      - op: add
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: standard
  - target:
      kind: StatefulSet
      name: redis
    patch: |-
      - op: add
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: standard
  # Update Ingress for local environment
  - target:
      kind: Ingress
      name: eventflow-ingress
    patch: |-
      - op: replace
        path: /spec/ingressClassName
        value: nginx
      - op: replace
        path: /spec/rules/0/host
        value: eventflow.local
  # Reduce resource requests for local development
  - target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/part-of=eventflow-platform"
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "25m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "32Mi"
  # Override ConfigMap values for local
  - target:
      kind: ConfigMap
      name: eventflow-config
    patch: |-
      - op: replace
        path: /data/ENVIRONMENT
        value: "development"
      - op: replace
        path: /data/LOG_LEVEL
        value: "debug"
      - op: replace
        path: /data/ALLOWED_ORIGINS
        value: "http://localhost:3001,http://eventflow.local,http://127.0.0.1:3001"
